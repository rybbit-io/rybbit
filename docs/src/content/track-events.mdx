# Track Custom Events

The script exposes a global object `window.rybbit` with functions for manual tracking of events.

## Available Functions

### `window.rybbit.event(eventName, properties)`

Tracks a custom event with optional properties.

*   `eventName` (String): The name of the custom event (max 255 characters).
*   `properties` (Object, Optional): An object containing custom data (max 2KB characters). Only strings numbers are supported as values.

```javascript
// Track a simple custom event
window.rybbit.event("Signup Button Clicked");

// Track a custom event with properties
window.rybbit.event("Item Added To Cart", {
  itemId: "PROD123",
  price: 49.99,
  category: "Clothing"
});
```

### `window.rybbit.pageview()`

Tracks a pageview. Useful when `data-track-spa` is set to `"false"` or when you need to manually trigger a pageview.

```javascript
// Track a pageview
window.rybbit.pageview();
```

### `window.rybbit.identify(userId)`

Sets a custom user ID for tracking logged-in users across devices and sessions.

*   `userId` (String): The unique identifier for the user. This will be stored in localStorage and persist across browser sessions. **Note: Custom user IDs are stored exactly as provided without any hashing or modification.**

```javascript
// Identify a user when they log in
window.rybbit.identify("user_12345");

// All subsequent events and pageviews will be associated with this user ID
```

### `window.rybbit.clearUserId()`

Clears the stored user ID. Useful when a user logs out.

```javascript
// Clear user identification when user logs out
window.rybbit.clearUserId();
```

### `window.rybbit.getUserId()`

Returns the currently set user ID, or `null` if none is set.

```javascript
// Check if a user is identified
const currentUserId = window.rybbit.getUserId();
if (currentUserId) {
  console.log('Current user:', currentUserId);
} else {
  console.log('No user identified');
}
```

## Global Properties

Global properties are custom data that are automatically sent with every pageview and event. They're perfect for setting context that applies to all tracking calls, such as user subscription status, app version, or feature flags.

### `window.rybbit.setGlobalProperties(properties)`

Sets global properties that will be sent with all subsequent pageviews and events. This replaces any existing global properties.

*   `properties` (Object): An object containing key-value pairs to be sent with every tracking call.

```javascript
// Set global properties
window.rybbit.setGlobalProperties({
  hasSubscription: true,
  appVersion: "1.23",
  userTier: "premium"
});

// All subsequent pageviews and events will include these properties
window.rybbit.pageview(); // Will include global properties
window.rybbit.event("Button Clicked"); // Will include global properties
```

### `window.rybbit.updateGlobalProperties(properties)`

Updates existing global properties by merging with new ones. Existing keys are overwritten, new keys are added.

```javascript
// Update specific global properties
window.rybbit.updateGlobalProperties({
  appVersion: "1.24", // Updates existing
  newFeature: true    // Adds new
});
```

### `window.rybbit.clearGlobalProperties()`

Clears all global properties.

```javascript
// Clear all global properties
window.rybbit.clearGlobalProperties();
```

### `window.rybbit.getGlobalProperties()`

Returns a copy of the current global properties.

```javascript
// Get current global properties
const currentGlobals = window.rybbit.getGlobalProperties();
console.log(currentGlobals);
```

{/* ### `window.rybbit.trackOutbound(url, text, target)`

Manually tracks outbound link clicks. Useful for programmatic navigation or custom link handling.

*   `url` (String): The full URL of the outbound link.
*   `text` (String, Optional): The text content of the link.
*   `target` (String, Optional): The target attribute of the link (defaults to "_self").

```javascript
// Track a programmatic navigation to an external site
window.rybbit.trackOutbound("https://example.com", "Example Site", "_blank");
``` */}

## Examples

### User Identification Example

Here's a typical workflow for user identification:

```javascript
// When user logs in
function handleLogin(userData) {
  // Set user identification
  window.rybbit.identify(userData.id);
  
  // Track login event
  window.rybbit.event("User Login", {
    method: "email",
    plan: userData.plan
  });
}

// When user logs out
function handleLogout() {
  // Track logout event
  window.rybbit.event("User Logout");
  
  // Clear user identification
  window.rybbit.clearUserId();
}

// Check identification status
function checkUserStatus() {
  const userId = window.rybbit.getUserId();
  if (userId) {
    console.log("User is identified:", userId);
  } else {
    console.log("Anonymous user");
  }
}
```

### Global Properties Example

```javascript
// Set global context when app loads
window.rybbit.setGlobalProperties({
  appVersion: "1.23",
  environment: "production",
  hasSubscription: false
});

// When user subscribes
function handleSubscription() {
  window.rybbit.updateGlobalProperties({
    hasSubscription: true,
    subscriptionTier: "premium"
  });
  
  // This event will include all global properties plus event-specific ones
  window.rybbit.event("Subscription Purchased", {
    plan: "yearly",
    amount: 99.99
  });
  // Sent properties: { 
  //   appVersion: "1.23", 
  //   environment: "production", 
  //   hasSubscription: true, 
  //   subscriptionTier: "premium",
  //   plan: "yearly", 
  //   amount: 99.99 
  // }
}

// Pageviews now automatically include global properties
window.rybbit.pageview();
// Sent properties: { 
//   appVersion: "1.23", 
//   environment: "production", 
//   hasSubscription: true, 
//   subscriptionTier: "premium" 
// }
```

### Property Merging

Event-specific properties take precedence over global properties when there are conflicts:

```javascript
// Set global properties
window.rybbit.setGlobalProperties({
  userId: "global_123",
  source: "app"
});

// Track event with conflicting properties
window.rybbit.event("Button Clicked", {
  userId: "event_456", // This overrides the global userId
  buttonType: "primary"
});

// Final properties sent: {
//   userId: "event_456",  // Event property overrides global
//   source: "app",        // Global property included
//   buttonType: "primary" // Event-specific property
// }
```

## TypeScript Support

Put this as `rybbit.d.ts` anywhere in your project to avoid having to do `(window as any).rybbit.event()` everywhere.

```typescript
interface Rybbit {
    /**
     * Tracks a page view
     */
    pageview: () => void;

    /**
     * Tracks a custom event
     * @param name Name of the event
     * @param properties Optional properties for the event
     */
    event: (name: string, properties?: Record<string, any>) => void;

    /**
     * Sets a custom user ID for tracking logged-in users
     * @param userId The user ID to set (will be stored in localStorage)
     */
    identify: (userId: string) => void;

    /**
     * Clears the stored user ID
     */
    clearUserId: () => void;

    /**
     * Gets the currently set user ID
     * @returns The current user ID or null if not set
     */
    getUserId: () => string | null;

    /**
     * Sets global properties that will be sent with all tracking calls
     * Replaces any existing global properties
     * @param properties Object containing key-value pairs
     */
    setGlobalProperties: (properties: Record<string, any>) => void;

    /**
     * Updates existing global properties by merging with new ones
     * @param properties Object containing key-value pairs to merge
     */
    updateGlobalProperties: (properties: Record<string, any>) => void;

    /**
     * Clears all global properties
     */
    clearGlobalProperties: () => void;

    /**
     * Gets a copy of the current global properties
     * @returns Object containing current global properties
     */
    getGlobalProperties: () => Record<string, any>;
}

declare global {
    interface Window {
        rybbit: Rybbit;
    }
}

export {};
```
